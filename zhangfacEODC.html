<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ“ç›˜æ‰‹å†³ç­–ç½—ç›˜ (v4.5 ) - å¼ å‘è´¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap');
        
        body { 
            font-family: 'Noto Sans SC', sans-serif; 
            background-color: #f0f4f8; 
            color: #1e293b;
            font-size: 16px; /* åŸºç¡€å­—å·å†æå‡ */
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        
        .input-group:focus-within label { color: #007BFF; }
        .input-group:focus-within input { border-color: #007BFF; ring: 2px; }

        /* æ»‘å—æ ·å¼ä¼˜åŒ– - æ›´å¤§ */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px; width: 20px; /* æ›´å¤§çš„æ»‘å— */
            border-radius: 50%;
            background: #007BFF;
            margin-top: -8px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: background 0.2s;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }
        
        input[type=range].danger::-webkit-slider-thumb { background: #ef4444; }
        input[type=range].safe::-webkit-slider-thumb { background: #22c55e; }

        .scenario-btn.active {
            background-color: #e6f2ff;
            border-color: #007BFF;
            color: #007BFF;
            font-weight: 700;
        }
        
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(250, 204, 21, 0); }
            100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); }
        }
        .btn-vip {
            animation: pulse-gold 2s infinite;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-[#007BFF] text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 bg-white text-[#007BFF] rounded-lg transform -rotate-3 flex items-center justify-center font-black text-3xl shadow-md border-2 border-yellow-400">è´¢</div>
                <div>
                    <h1 class="text-2xl font-bold tracking-wide hidden sm:block">æ“ç›˜æ‰‹å†³ç­–ç½—ç›˜ <span class="text-sm bg-blue-800 text-blue-100 px-2 py-0.5 rounded ml-1 font-normal align-middle">v4.5 è€èŠ±å‹å¥½ç‰ˆ</span></h1>
                    <h1 class="text-xl font-bold tracking-wide sm:hidden">æ“ç›˜æ‰‹ç½—ç›˜</h1>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="toggleHistory()" class="group text-base bg-blue-900/30 hover:bg-blue-900/50 border border-blue-200/20 text-blue-50 px-5 py-2.5 rounded-full transition-all flex items-center gap-2 backdrop-blur-sm">
                    <i class="fas fa-history opacity-70 group-hover:opacity-100 transition-opacity"></i> 
                    <span class="hidden sm:inline font-medium">å†å²</span>
                </button>
                
                <a href="https://zhangfac-888.github.io/utility-box/zhangfacrlh.html" target="_blank" class="btn-vip relative px-6 py-3 bg-slate-900 text-yellow-400 font-bold text-base rounded-full transition-all transform hover:-translate-y-0.5 hover:shadow-xl flex items-center gap-2 border border-yellow-600/30 shadow-lg">
                    <span class="absolute -top-1 -right-1 flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-500 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500 border border-slate-900"></span>
                    </span>
                    <i class="fas fa-crown text-yellow-500"></i>
                    <span>èµ„æ–™åº“ 3.0</span>
                </a>
            </div>
        </div>
    </header>

    <!-- åœºæ™¯é€‰æ‹©æ  -->
    <div class="bg-white border-b border-gray-200 sticky top-[76px] z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-5 overflow-x-auto whitespace-nowrap scrollbar-hide flex items-center">
            <span class="text-base font-bold text-gray-500 mr-4 uppercase">ä¸€é”®åœºæ™¯:</span>
            <button onclick="loadScenario('fashion')" class="scenario-btn inline-flex items-center gap-2 px-5 py-2.5 rounded-full border border-gray-200 text-base font-medium text-gray-600 hover:bg-gray-50 transition mr-3">
                <i class="fas fa-tshirt"></i> æœé¥°æ¸…ä»“
            </button>
            <button onclick="loadScenario('beauty')" class="scenario-btn inline-flex items-center gap-2 px-5 py-2.5 rounded-full border border-gray-200 text-base font-medium text-gray-600 hover:bg-gray-50 transition mr-3">
                <i class="fas fa-spray-can"></i> ç¾å¦†æ–°å“
            </button>
            <button onclick="loadScenario('highTicket')" class="scenario-btn inline-flex items-center gap-2 px-5 py-2.5 rounded-full border border-gray-200 text-base font-medium text-gray-600 hover:bg-gray-50 transition mr-3">
                <i class="fas fa-couch"></i> å®¶ç”µå®¶å±…
            </button>
            <button onclick="resetForm()" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full border border-dashed border-gray-300 text-base font-medium text-gray-400 hover:text-red-500 hover:border-red-300 transition ml-auto">
                <i class="fas fa-trash-alt"></i> æ¸…ç©º
            </button>
        </div>
    </div>

    <main class="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
        
        <!-- å·¦ä¾§ï¼šè¾“å…¥ä¸é…ç½® (å 7åˆ—) -->
        <div class="lg:col-span-7 space-y-8">
            
            <!-- æ¨¡å—1: æµé‡ä¸è½¬åŒ– -->
            <div class="bg-white rounded-xl card-shadow border-l-4 border-[#007BFF] group hover:shadow-md transition-shadow">
                <div class="px-6 py-5 border-b border-gray-100 flex justify-between items-center bg-blue-50/30">
                    <h2 class="font-bold text-gray-800 text-lg flex items-center gap-2"><i class="fas fa-filter text-[#007BFF]"></i> æµé‡æ¼æ–— (å‰ç«¯)</h2>
                    <span class="text-sm text-gray-400">è¾“å…¥åŸºç¡€æŠ•æ”¾æ•°æ®</span>
                </div>
                <div class="p-6 grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div class="input-group">
                        <label class="block text-sm font-bold text-gray-500 uppercase mb-2">æ¨å¹¿èŠ±è´¹</label>
                        <input type="number" id="adCost" class="w-full text-xl font-mono font-bold border-b-2 border-gray-200 bg-transparent py-2 focus:outline-none transition" value="2000" oninput="calc()">
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-bold text-gray-500 uppercase mb-2">æˆäº¤é¢ (GMV)</label>
                        <input type="number" id="adGmv" class="w-full text-xl font-mono font-bold border-b-2 border-gray-200 bg-transparent py-2 focus:outline-none transition" value="4500" oninput="calc()">
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-bold text-gray-500 uppercase mb-2">PPC (ç‚¹å‡»æˆæœ¬)</label>
                        <input type="number" id="ppc" class="w-full text-xl font-mono font-bold border-b-2 border-gray-200 bg-transparent py-2 focus:outline-none transition" value="1.5" step="0.1" oninput="calc()">
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-bold text-gray-500 uppercase mb-2">å®¢å•ä»·</label>
                        <input type="number" id="avgTicket" class="w-full text-xl font-mono font-bold border-b-2 border-gray-200 bg-transparent py-2 focus:outline-none transition" value="89" oninput="calc()">
                    </div>
                </div>
            </div>

            <!-- æ¨¡å—2: çœŸå®æˆæœ¬ç»“æ„ -->
            <div class="bg-white rounded-xl card-shadow border-l-4 border-red-500 group hover:shadow-md transition-shadow">
                <div class="px-6 py-5 border-b border-gray-100 flex justify-between items-center bg-red-50/30">
                    <h2 class="font-bold text-gray-800 text-lg flex items-center gap-2"><i class="fas fa-cut text-red-500"></i> æˆæœ¬ç»“æ„ (åˆ«è‡ªæ¬ºæ¬ºäºº)</h2>
                </div>
                <div class="p-6 space-y-6">
                    <!-- å˜åŠ¨æˆæœ¬ -->
                    <div class="grid grid-cols-3 gap-6">
                        <div class="input-group">
                            <label class="block text-sm font-bold text-gray-500 uppercase mb-2">äº§å“æˆæœ¬ (æ‹¿è´§ä»·)</label>
                            <input type="number" id="productCost" class="w-full text-xl font-mono font-bold border-b-2 border-gray-200 bg-transparent py-2 focus:outline-none" value="35" oninput="calc()">
                        </div>
                        <div class="input-group">
                            <label class="block text-sm font-bold text-gray-500 uppercase mb-2">å•å‡å±¥çº¦ (å¿«é€’+æ‰“åŒ…)</label>
                            <input type="number" id="fulfillmentCost" class="w-full text-xl font-mono font-bold border-b-2 border-gray-200 bg-transparent py-2 focus:outline-none" value="4.5" oninput="calc()">
                        </div>
                        <div class="input-group">
                            <label class="block text-sm font-bold text-gray-500 uppercase mb-2">å¹³å°ä½£é‡‘+æ”¯ä»˜ (%)</label>
                            <input type="number" id="platformFeeRate" class="w-full text-xl font-mono font-bold border-b-2 border-gray-200 bg-transparent py-2 focus:outline-none" value="5.5" step="0.1" oninput="calc()">
                        </div>
                    </div>

                    <!-- é£é™©ä¸å›ºå®šæˆæœ¬ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 pt-5 border-t border-dashed border-gray-200">
                        <div class="input-group col-span-1">
                            <label class="block text-sm font-bold text-gray-500 uppercase mb-2 text-red-600">é€€æ¬¾ç‡ (%)</label>
                            <input type="number" id="refundRate" class="w-full text-xl font-mono font-bold border-b-2 border-red-100 bg-transparent py-2 focus:outline-none" value="15" oninput="calc()">
                        </div>
                         <div class="input-group col-span-1">
                            <label class="block text-sm font-bold text-gray-500 uppercase mb-2 text-red-600" title="é€€ä¸€å•äºå¤šå°‘è¿è´¹">é€€è´§è¿è´¹æŸå¤±/å•</label>
                            <input type="number" id="returnLoss" class="w-full text-xl font-mono font-bold border-b-2 border-red-100 bg-transparent py-2 focus:outline-none" value="5" oninput="calc()">
                        </div>
                        
                        <!-- å›ºå®šæˆæœ¬æ‘Šé”€è®¡ç®—å™¨ -->
                        <div class="col-span-2 bg-slate-50 p-4 rounded border border-slate-200 hover:border-[#007BFF] transition-colors">
                            <label class="flex justify-between text-sm font-bold text-gray-500 uppercase mb-2 cursor-pointer" onclick="toggleFixedDetails()">
                                <span>å›ºå®šæˆæœ¬æ‘Šé”€ (äººåŠ›/æˆ¿ç§Ÿ)</span>
                                <i class="fas fa-calculator text-[#007BFF]"></i>
                            </label>
                            <div class="flex gap-3 items-end">
                                <div class="flex-1">
                                    <input type="number" id="fixedCostPerOrder" class="w-full text-lg font-bold text-slate-700 bg-white border border-slate-300 rounded px-3 py-2" value="3.0" oninput="calc()">
                                </div>
                                <div class="text-sm text-gray-400 pb-2">å…ƒ/å•</div>
                            </div>
                            <div id="fixedDetails" class="hidden mt-3 text-sm space-y-2 border-t border-slate-200 pt-2">
                                <div class="flex justify-between items-center">
                                    <span>æœˆå›ºå®šæ€»æ”¯å‡º:</span>
                                    <input type="number" id="monthFixedTotal" placeholder="15000" class="w-24 border-b text-right bg-transparent" oninput="calcFixed()">
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>æœˆé¢„ä¼°æ€»å•é‡:</span>
                                    <input type="number" id="monthOrders" placeholder="5000" class="w-24 border-b text-right bg-transparent" oninput="calcFixed()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¨¡å—3: å¢é•¿æ æ† -->
            <div class="bg-white rounded-xl card-shadow border-l-4 border-green-500 group hover:shadow-md transition-shadow">
                <div class="px-6 py-5 border-b border-gray-100 flex justify-between items-center bg-green-50/30">
                    <h2 class="font-bold text-gray-800 text-lg flex items-center gap-2"><i class="fas fa-chart-line text-green-500"></i> å¢é•¿æ æ† (åˆ«åªçœ‹é¦–å•)</h2>
                </div>
                <div class="p-6 grid grid-cols-2 gap-8">
                    <div>
                        <label class="block text-sm font-bold text-gray-500 uppercase mb-2">è‡ªç„¶æµé‡æ’¬åŠ¨æ¯” (åŸºäºè®¢å•)</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="organicRatioSlide" min="0" max="2" step="0.1" value="0.5" class="w-28" oninput="updateRange('organicRatioSlide', 'organicRatioDisplay'); calc()">
                            <span id="organicRatioDisplay" class="text-xl font-mono font-bold text-green-600">0.5</span>
                            <span class="text-base text-gray-400">å€</span>
                        </div>
                        <p class="text-sm text-gray-400 mt-2">æ¯1ä¸ªä»˜è´¹è®¢å•å¸¦æ¥Xä¸ªè‡ªç„¶è®¢å•</p>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                             <label class="block text-sm font-bold text-gray-500 uppercase">LTV (å¤è´­å¢å€¼)</label>
                             <!-- LTV å‚è€ƒæŒ‰é’® -->
                             <button onclick="setLtvRef()" class="text-sm text-[#007BFF] bg-blue-50 px-3 py-1 rounded-full hover:bg-blue-100 transition">å¡«å…¥å‚è€ƒå€¼</button>
                        </div>
                       
                        <div class="flex items-center gap-3">
                            <span class="text-base text-gray-400">+</span>
                            <input type="number" id="ltvAdd" value="0" class="w-24 border-b border-gray-300 text-center font-mono text-xl font-bold" oninput="calc()">
                            <span class="text-base text-gray-400">å…ƒ/å®¢æˆ·</span>
                        </div>
                        <p class="text-sm text-gray-400 mt-2">å®¢æˆ·ç”Ÿå‘½å‘¨æœŸè´¡çŒ®çš„é¢å¤–æ¯›åˆ©</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- å³ä¾§ï¼šå†³ç­–åˆ†æé¢æ¿ (å 5åˆ—) -->
        <div class="lg:col-span-5 space-y-8 lg:sticky lg:top-24">
            
            <!-- ç»“æœæ€»è§ˆå¡ç‰‡ -->
            <div class="bg-white rounded-xl card-shadow overflow-hidden border-t-4 border-[#007BFF]">
                <div class="bg-[#007BFF] px-6 py-6 relative overflow-hidden">
                     <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full transform translate-x-10 -translate-y-10"></div>
                     <h3 class="text-base font-bold text-blue-100 uppercase tracking-wider mb-2">ç»¼åˆå†³ç­–åˆ†æ</h3>
                     <div class="flex items-end justify-between">
                        <div>
                            <div class="text-6xl font-black tracking-tight text-white" id="totalNetProfit">Â¥ 0</div>
                            <div class="text-base text-blue-100 mt-1">æœ€ç»ˆå‡€åˆ©æ¶¦ (å«è‡ªç„¶æµ&LTV)</div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold text-green-300" id="totalNetRate">0%</div>
                             <div class="text-base text-blue-100">çœŸå®å‡€åˆ©ç‡</div>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 bg-white">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-5 rounded-lg border border-gray-100 text-center">
                            <div class="text-sm text-gray-500 font-bold uppercase mb-1">å‰ç«¯ ROI (é¦–å•)</div>
                            <div class="text-3xl font-bold text-gray-700 font-mono" id="frontRoi">0.00</div>
                            <div class="text-sm text-gray-500 mt-2 bg-white inline-block px-3 py-1 rounded border border-gray-200">ç›ˆäºçº¿: <span id="beRoiFront" class="text-orange-500 font-bold">--</span></div>
                        </div>
                        <div class="bg-blue-50 p-5 rounded-lg border border-blue-100 text-center relative overflow-hidden">
                            <div class="text-sm text-[#007BFF] font-bold uppercase mb-1">ç»¼åˆ ROI (å…¨ç”Ÿå‘½å‘¨æœŸ)</div>
                            <div class="text-3xl font-bold text-[#007BFF] font-mono" id="totalRoi">0.00</div>
                            <div class="text-sm text-blue-500 mt-2 bg-white/50 inline-block px-3 py-1 rounded">ç›ˆäºçº¿: <span id="beRoiTotal" class="text-blue-700 font-bold">--</span></div>
                            <i class="fas fa-layer-group absolute right-2 bottom-2 text-blue-200 text-4xl opacity-50"></i>
                        </div>
                    </div>

                    <!-- ç»“æœæ ‡ç­¾ -->
                    <div id="resultBadge" class="mt-6 py-3 px-4 rounded-lg text-base font-bold text-center bg-gray-100 text-gray-500">
                        ç­‰å¾…è®¡ç®—...
                    </div>
                </div>
            </div>

            <!-- æ•æ„Ÿæ€§åˆ†æ (æ²™ç›˜æ¨æ¼”) -->
            <div class="bg-white rounded-xl card-shadow p-6 border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-800 text-lg"><i class="fas fa-chess-board text-purple-500"></i> æ²™ç›˜æ¨æ¼” (What-if)</h3>
                    <button onclick="resetSim()" class="text-sm text-[#007BFF] hover:underline font-bold">é‡ç½®</button>
                </div>
                
                <div class="space-y-8">
                    <!-- PPC æ¨æ¼” -->
                    <div class="group relative">
                        <div class="flex justify-between text-base mb-2">
                            <span class="font-bold text-gray-600">PPC æ³¢åŠ¨</span>
                            <span class="font-bold text-purple-600 font-mono" id="simPpcVal">0%</span>
                        </div>
                        <input type="range" id="simPpc" min="-50" max="50" value="0" step="5" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateSim()">
                        <div class="flex justify-between text-sm text-gray-400 mt-2">
                            <span>-50%</span>
                            <span>å½“å‰</span>
                            <span>+50%</span>
                        </div>
                    </div>

                    <!-- è½¬åŒ–ç‡ æ¨æ¼” -->
                    <div>
                        <div class="flex justify-between text-base mb-2">
                            <span class="font-bold text-gray-600">è½¬åŒ–ç‡ æ³¢åŠ¨</span>
                            <span class="font-bold text-purple-600 font-mono" id="simCvrVal">0%</span>
                        </div>
                        <input type="range" id="simCvr" min="-50" max="50" value="0" step="5" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateSim()">
                         <div class="flex justify-between text-sm text-gray-400 mt-2">
                            <span>-50%</span>
                            <span>å½“å‰</span>
                            <span>+50%</span>
                        </div>
                    </div>

                    <!-- æ¨æ¼”ç»“æœ -->
                    <div id="simResultBox" class="bg-gray-50 p-5 rounded-lg border border-gray-200 mt-4 transition-colors duration-300">
                        <div class="text-base text-gray-600 text-center">æ¨æ¼”åé¢„è®¡å‡€åˆ©: <span class="font-bold text-gray-400 text-2xl ml-2 font-mono" id="simResult">--</span></div>
                    </div>
                </div>
            </div>

            <!-- æ¯’èˆŒå»ºè®® & èµ„æ–™åº“å¼•å¯¼ -->
            <div class="bg-white rounded-xl card-shadow p-6 relative">
                <i class="fas fa-quote-right absolute top-5 right-5 text-gray-100 text-6xl"></i>
                <h3 class="font-bold text-gray-800 text-lg mb-4">å¼ å‘è´¢çš„æ¯’èˆŒè¯Šæ–­</h3>
                <div id="diagnosis" class="text-base text-gray-600 leading-relaxed space-y-4">
                    <!-- JS ç”Ÿæˆ -->
                </div>
                <!-- ä¸»æ“ä½œæŒ‰é’®ä½¿ç”¨ä¸»è‰²è°ƒ -->
                <button onclick="saveResult()" class="mt-8 w-full bg-[#007BFF] hover:bg-blue-600 text-white text-base font-bold py-3.5 rounded-lg transition shadow-lg shadow-blue-200 active:scale-[0.98]">
                    ä¿å­˜å¹¶åˆ†æ
                </button>

                <!-- èµ„æ–™åº“å¼•æµå¡ç‰‡ -->
                <a href="https://zhangfac-888.github.io/utility-box/zhangfacrlh.html" target="_blank" class="block mt-6 group">
                    <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-lg p-1 border border-slate-700 shadow-xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-24 h-full bg-gradient-to-l from-white/10 to-transparent skew-x-12"></div>
                        <div class="px-5 py-4 flex items-center justify-between relative z-10">
                            <div>
                                <div class="text-xs text-yellow-400 font-bold uppercase tracking-wider mb-1"><i class="fas fa-lightbulb"></i> è¢«éª‚äº†ä¸çŸ¥é“æ€ä¹ˆæ”¹ï¼Ÿ</div>
                                <div class="text-base font-bold text-white group-hover:text-yellow-300 transition-colors">ğŸ‘‰ è¿›å…¥å¼ å‘è´¢çš„å®æˆ˜èµ„æ–™åº“</div>
                            </div>
                            <div class="h-10 w-10 bg-yellow-400 rounded-full flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                                <i class="fas fa-arrow-right text-slate-900 text-sm"></i>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

        </div>
    </main>
    
    <!-- å†å²è®°å½•æŠ½å±‰ -->
    <div id="historyDrawer" class="fixed inset-y-0 right-0 w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 p-8 overflow-y-auto border-l-4 border-[#007BFF]">
        <div class="flex justify-between items-center mb-8">
            <h3 class="font-bold text-xl text-[#007BFF]">å†å²æ¨æ¼”è®°å½•</h3>
            <button onclick="toggleHistory()" class="text-gray-400 hover:text-gray-600 p-2"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div id="historyList" class="space-y-4">
            <!-- å†å²åˆ—è¡¨ -->
            <p class="text-base text-gray-400 text-center py-10">æš‚æ— è®°å½•ï¼Œç‚¹å‡»"ä¿å­˜å¹¶åˆ†æ"æ·»åŠ </p>
        </div>
        <button onclick="clearHistory()" class="mt-8 w-full border border-red-200 text-red-500 text-sm py-3 rounded-lg hover:bg-red-50 font-bold transition">æ¸…ç©ºå†å²</button>
    </div>

    <script>
        // åœºæ™¯é¢„è®¾æ•°æ®
        const scenarios = {
            'fashion': { 
                adCost: 3000, adGmv: 6000, ppc: 0.8, avgTicket: 120, 
                productCost: 50, fulfillmentCost: 4, platformFeeRate: 5, 
                refundRate: 35, returnLoss: 6, fixedCostPerOrder: 2,
                organicRatio: 0.2, ltvAdd: 0 
            },
            'beauty': { 
                adCost: 5000, adGmv: 9000, ppc: 2.5, avgTicket: 189, 
                productCost: 35, fulfillmentCost: 3.5, platformFeeRate: 6, 
                refundRate: 5, returnLoss: 4, fixedCostPerOrder: 5,
                organicRatio: 0.5, ltvAdd: 150 
            },
            'highTicket': { 
                adCost: 8000, adGmv: 20000, ppc: 4.0, avgTicket: 899, 
                productCost: 400, fulfillmentCost: 30, platformFeeRate: 4, 
                refundRate: 8, returnLoss: 50, fixedCostPerOrder: 20,
                organicRatio: 0.1, ltvAdd: 0 
            }
        };

        let currentData = {};
        let currentCategory = 'fashion'; // é»˜è®¤ä¸ºæœé¥°

        function get(id) { return parseFloat(document.getElementById(id).value) || 0; }
        function set(id, val) { 
            const el = document.getElementById(id);
            if(el.tagName === 'INPUT') el.value = val;
            else el.innerText = val;
        }

        function loadScenario(type) {
            currentCategory = type;
            const data = scenarios[type];
            if(!data) return;
            
            document.getElementById('adCost').value = data.adCost;
            document.getElementById('adGmv').value = data.adGmv;
            document.getElementById('ppc').value = data.ppc;
            document.getElementById('avgTicket').value = data.avgTicket;
            document.getElementById('productCost').value = data.productCost;
            document.getElementById('fulfillmentCost').value = data.fulfillmentCost;
            document.getElementById('platformFeeRate').value = data.platformFeeRate;
            document.getElementById('refundRate').value = data.refundRate;
            document.getElementById('returnLoss').value = data.returnLoss;
            document.getElementById('fixedCostPerOrder').value = data.fixedCostPerOrder;
            document.getElementById('ltvAdd').value = data.ltvAdd;
            
            const range = document.getElementById('organicRatioSlide');
            range.value = data.organicRatio;
            updateRange('organicRatioSlide', 'organicRatioDisplay');

            document.querySelectorAll('.scenario-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');

            resetSim();
            calc();
        }

        function updateRange(id, displayId) {
            document.getElementById(displayId).innerText = document.getElementById(id).value;
        }

        function toggleFixedDetails() {
            document.getElementById('fixedDetails').classList.toggle('hidden');
        }

        function calcFixed() {
            const total = get('monthFixedTotal');
            const orders = get('monthOrders');
            if(orders > 0) {
                document.getElementById('fixedCostPerOrder').value = (total / orders).toFixed(2);
                calc();
            }
        }

        function setLtvRef() {
            if(currentCategory === 'beauty') {
                document.getElementById('ltvAdd').value = 150;
                alert('å·²å¡«å…¥ç¾å¦†è¡Œä¸šå‚è€ƒLTVï¼š150å…ƒ (å‡è®¾å¤è´­2-3æ¬¡)');
            } else if (currentCategory === 'fashion') {
                document.getElementById('ltvAdd').value = 80;
                alert('å·²å¡«å…¥æœé¥°è¡Œä¸šå‚è€ƒLTVï¼š80å…ƒ (å‡è®¾å­£åº¦æ¢æ–°)');
            } else {
                document.getElementById('ltvAdd').value = 50;
                alert('å·²å¡«å…¥é€šç”¨å‚è€ƒLTVï¼š50å…ƒ');
            }
            calc();
        }

        function calculateMetrics(simPpcPercent = 0, simCvrPercent = 0) {
            const originalAdCost = get('adCost');
            const originalAdGmv = get('adGmv');
            const originalPpc = get('ppc');
            const avgTicket = get('avgTicket');
            
            const originalClicks = originalPpc > 0 ? originalAdCost / originalPpc : 0;
            const originalOrders = avgTicket > 0 ? originalAdGmv / avgTicket : 0;
            const originalCvr = originalClicks > 0 ? originalOrders / originalClicks : 0;
            
            let currentPpc = originalPpc * (1 + simPpcPercent/100);
            let currentCvr = originalCvr * (1 + simCvrPercent/100);
            
            let currentAdCost = originalClicks * currentPpc; 
            
            let currentPaidOrders = originalClicks * currentCvr; 
            let currentAdGmv = currentPaidOrders * avgTicket;
            
            const productCost = get('productCost');
            const fulfillment = get('fulfillmentCost');
            const feeRate = get('platformFeeRate') / 100;
            const refundRate = get('refundRate') / 100;
            const returnLoss = get('returnLoss');
            const fixedCost = get('fixedCostPerOrder');
            const organicRatio = parseFloat(document.getElementById('organicRatioSlide').value);
            const ltvAdd = get('ltvAdd');
            
            const paidSuccessOrders = currentPaidOrders * (1 - refundRate);
            const paidRevenue = paidSuccessOrders * avgTicket;
            
            const organicOrders = currentPaidOrders * organicRatio;
            const organicSuccessOrders = organicOrders * (1 - refundRate);
            const organicRevenue = organicSuccessOrders * avgTicket;
            
            const totalOrders = currentPaidOrders + organicOrders; 
            const totalSuccessOrders = paidSuccessOrders + organicSuccessOrders; 
            const totalRevenue = paidRevenue + organicRevenue; 
            
            const totalProductCost = totalOrders * productCost; 
            const totalFulfillment = totalOrders * fulfillment; 
            const totalReturnLoss = (totalOrders * refundRate) * returnLoss; 
            const totalPlatformFee = totalRevenue * feeRate; 
            const totalFixedCost = totalOrders * fixedCost; 
            
            const totalOpsCost = totalProductCost + totalFulfillment + totalReturnLoss + totalPlatformFee + totalFixedCost;
            const totalCost = currentAdCost + totalOpsCost;
            
            const currentNetProfit = totalRevenue - totalCost; 
            const ltvValue = totalSuccessOrders * ltvAdd; 
            const totalProfit = currentNetProfit + ltvValue; 
            
            const frontRoi = currentAdCost > 0 ? currentAdGmv / currentAdCost : 0; 
            const totalRoi = currentAdCost > 0 ? (totalRevenue + ltvValue) / currentAdCost : 0; 
            
            const unitRevenue = avgTicket * (1 - refundRate);
            const unitVariableCost = productCost + fulfillment + (avgTicket * feeRate) + (refundRate * returnLoss) + fixedCost;
            const unitNetProfitFront = unitRevenue - unitVariableCost;
            
            const frontBreakEven = unitNetProfitFront > 0 ? avgTicket / unitNetProfitFront : 999;
            
            const unitTotalVal = unitNetProfitFront * (1 + organicRatio) + (1 + organicRatio) * (1 - refundRate) * ltvAdd;
            const totalBreakEven = unitTotalVal > 0 ? avgTicket / unitTotalVal : 999;

            return {
                netProfitTotal: totalProfit,
                frontRoi,
                totalRoi,
                frontBreakEven,
                totalBreakEven,
                netRate: totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0,
                unitNetProfitFront,
                adCost: currentAdCost 
            };
        }

        function calc() {
            const res = calculateMetrics();
            currentData = res;

            set('totalNetProfit', `Â¥ ${res.netProfitTotal.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`);
            set('totalNetRate', `${res.netRate.toFixed(1)}%`);
            set('frontRoi', res.frontRoi.toFixed(2));
            set('totalRoi', res.totalRoi.toFixed(2));
            
            set('beRoiFront', res.frontBreakEven > 100 ? 'âˆ' : res.frontBreakEven.toFixed(2));
            set('beRoiTotal', res.totalBreakEven > 100 ? 'âˆ' : res.totalBreakEven.toFixed(2));

            updateBadge(res.netProfitTotal, res.netRate);
            updateDiagnosis(res);
            
            if(document.getElementById('simPpc').value != 0 || document.getElementById('simCvr').value != 0) {
                updateSim();
            } else {
                set('simResult', '--');
                document.getElementById('simResultBox').className = "bg-gray-50 p-5 rounded-lg border border-gray-200 mt-4 transition-colors duration-300";
            }
        }

        function updateBadge(profit, rate) {
            const el = document.getElementById('resultBadge');
            if(profit > 1000 && rate > 15) {
                el.className = "mt-6 py-3 px-4 rounded-lg text-base font-bold text-center bg-green-500 text-white shadow-lg shadow-green-200";
                el.innerHTML = "<i class='fas fa-star'></i> ä¼˜è´¨é¡¹ç›® - å»ºè®®æ”¾å¤§é¢„ç®—";
            } else if (profit >= 0) {
                el.className = "mt-6 py-3 px-4 rounded-lg text-base font-bold text-center bg-[#007BFF] text-white";
                el.innerHTML = "<i class='fas fa-check'></i> ç›ˆåˆ©æ¨¡å‹ - éœ€ç²¾ç»†åŒ–è¿è¥";
            } else if (profit > -500) {
                el.className = "mt-6 py-3 px-4 rounded-lg text-base font-bold text-center bg-yellow-500 text-white";
                el.innerHTML = "<i class='fas fa-exclamation-triangle'></i> é£é™©é¡¹ç›® - ç›ˆäºè¾¹ç¼˜è¯•æ¢";
            } else {
                el.className = "mt-6 py-3 px-4 rounded-lg text-base font-bold text-center bg-red-600 text-white animate-pulse";
                el.innerHTML = "<i class='fas fa-skull'></i> ä¸¥é‡äºæŸ - ç«‹å³åœæ­¢æŠ•æ”¾";
            }
        }

        function updateDiagnosis(res) {
            const box = document.getElementById('diagnosis');
            let msg = [];
            const adCost = get('adCost');

            if(res.frontRoi < res.frontBreakEven) {
                const cpa = get('avgTicket') / res.frontRoi;
                const profitPerPaid = res.unitNetProfitFront - cpa;
                
                msg.push(`<p class="text-red-600 font-bold">ğŸ”¥ å‰ç«¯åœ¨çƒ§é’±ï¼š</p><p>é¦–å•ROI ${res.frontRoi.toFixed(2)} < ç›ˆäºçº¿ ${res.frontBreakEven.toFixed(2)}ã€‚è¿™æ„å‘³ç€ä½ æ¯å–å‡ºä¸€ä¸ªä»˜è´¹å•ï¼Œå°±åœ¨ç›´æ¥äºæŸ <span class="font-black">Â¥${Math.abs(profitPerPaid).toFixed(1)}</span>ã€‚</p>`);
            } else {
                msg.push(`<p class="text-green-600 font-bold">âœ… å‰ç«¯å·²ç›ˆåˆ©ï¼š</p><p>é¦–å•èƒ½è‡ªå·±é€ è¡€ï¼Œè¿™å¾ˆéš¾å¾—ã€‚åªè¦é‡èƒ½è·‘èµ·æ¥ï¼Œä½ å°±æ˜¯å°é’æœºã€‚</p>`);
            }

            if(get('ltvAdd') === 0 && (currentCategory === 'beauty' || currentCategory === 'fashion')) {
                msg.push(`<p class="text-orange-600 mt-2 font-bold">âš ï¸ LTVä¸º0æ˜¯è‡ªæ¬ºæ¬ºäººï¼š</p><p>åšç¾å¦†/æœé¥°ä¸ç®—å¤è´­å°±æ˜¯è€æµæ°“ã€‚ç‚¹å‡»ä¸Šæ–¹â€œå¡«å…¥å‚è€ƒå€¼â€ï¼Œçœ‹çœ‹åŠ ä¸Šå¤è´­ä½ èƒ½èµšå¤šå°‘ã€‚</p>`);
            }

            if(res.netProfitTotal < 0) {
                msg.push(`<p class="text-slate-500 mt-2">â˜ ï¸ æœ€ç»ˆç»“è®ºï¼šç®—äº†è‡ªç„¶æµå’Œå¤è´­è¿˜æ˜¯äºã€‚ä½ çš„é—®é¢˜ä¸åœ¨æŠ•æ”¾ï¼Œåœ¨å“ï¼ˆåç«¯æˆæœ¬å¤ªé‡ï¼‰æˆ–è€…é€€è´§ç‡å¤±æ§ã€‚</p>`);
            }

            box.innerHTML = msg.join('');
        }

        function updateSim() {
            const ppcChange = parseInt(document.getElementById('simPpc').value);
            const cvrChange = parseInt(document.getElementById('simCvr').value);
            
            const ppcRange = document.getElementById('simPpc');
            ppcRange.className = `w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer ${ppcChange > 0 ? 'danger' : (ppcChange < 0 ? 'safe' : '')}`;
            
            const cvrRange = document.getElementById('simCvr');
            cvrRange.className = `w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer ${cvrChange < 0 ? 'danger' : (cvrChange > 0 ? 'safe' : '')}`;

            document.getElementById('simPpcVal').innerText = (ppcChange > 0 ? '+' : '') + ppcChange + '%';
            document.getElementById('simCvrVal').innerText = (cvrChange > 0 ? '+' : '') + cvrChange + '%';
            
            const res = calculateMetrics(ppcChange, cvrChange);
            const el = document.getElementById('simResult');
            const box = document.getElementById('simResultBox');

            el.innerText = `Â¥ ${res.netProfitTotal.toLocaleString('en-US', {maximumFractionDigits:0})}`;
            
            if(res.netProfitTotal < 0) {
                el.className = "font-bold text-red-600 text-2xl ml-2 font-mono";
                box.className = "bg-red-50 p-5 rounded-lg border border-red-200 mt-4 transition-colors duration-300";
            } else {
                el.className = "font-bold text-green-600 text-2xl ml-2 font-mono";
                box.className = "bg-green-50 p-5 rounded-lg border border-green-200 mt-4 transition-colors duration-300";
            }
        }

        function resetSim() {
            document.getElementById('simPpc').value = 0;
            document.getElementById('simCvr').value = 0;
            updateSim();
            set('simResult', '--');
        }
        
        function toggleHistory() {
            const drawer = document.getElementById('historyDrawer');
            if(drawer.classList.contains('translate-x-full')) {
                drawer.classList.remove('translate-x-full');
                renderHistory();
            } else {
                drawer.classList.add('translate-x-full');
            }
        }

        function saveResult() {
            const history = JSON.parse(localStorage.getItem('roi_history') || '[]');
            const entry = {
                time: new Date().toLocaleString(),
                profit: currentData.netProfitTotal,
                roi: currentData.totalRoi,
                gmv: get('adGmv'),
                adCost: get('adCost')
            };
            history.unshift(entry);
            if(history.length > 20) history.pop();
            localStorage.setItem('roi_history', JSON.stringify(history));
            toggleHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('roi_history') || '[]');
            const list = document.getElementById('historyList');
            if(history.length === 0) {
                list.innerHTML = '<p class="text-base text-gray-400 text-center py-10">æš‚æ— è®°å½•</p>';
                return;
            }
            list.innerHTML = history.map(h => `
                <div class="bg-gray-50 p-4 rounded-lg border-l-4 ${h.profit >= 0 ? 'border-green-400' : 'border-red-400'} text-sm">
                    <div class="flex justify-between text-gray-400 mb-2">
                        <span>${h.time.split(' ')[0]}</span>
                        <span>å…¨ROI: ${h.roi.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center font-bold text-gray-700">
                        <span>æŠ•å…¥: Â¥${h.adCost}</span>
                        <span class="${h.profit>=0 ? 'text-green-600' : 'text-red-600'}">åˆ©: Â¥${h.profit.toFixed(0)}</span>
                    </div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if(confirm('ç¡®å®šæ¸…ç©ºå†å²è®°å½•ï¼Ÿ')) {
                localStorage.removeItem('roi_history');
                renderHistory();
            }
        }

        function resetForm() {
             document.querySelectorAll('input').forEach(input => {
                if(input.type === 'number') input.value = 0;
                if(input.id === 'ppc') input.value = 1; 
             });
             calc();
        }

        window.onload = function() {
            calc();
        };
    </script>
</body>
</html>
